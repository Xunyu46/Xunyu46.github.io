import{_ as t,r as p,o,c as i,b as s,d as n,e as c,a}from"./app-48690364.js";const l={},u=a(`<p>前面的几个小节，我们从 Vite 双引擎的角度了解了 Vite 的整体架构，也系统学了双引擎本身的基础知识。从本小节开始，我们正式学习 <strong>Vite 高级应用</strong>。</p><p>这一模块中，我们将深入应用 Vite 的各项高级能力，遇到更多有挑战的开发场景。你不仅能学会一系列有难度的<strong>解决方案</strong>，直接运用到实际项目中，还能系统提高自己的<strong>知识深度</strong>，体会复杂项目场景中构建工具如何提供高度自定义的能力，以及如何对项目进行性能优化。</p><p>说到自定义的能力，你肯定很容易想到<code>插件机制</code>，利用一个个插件来扩展构建工具自身的能力。没错，这一节中我们将系统学习 Vite 的插件机制，带你掌握 Vite 插件开发的基本知识以及实战开发技巧。</p><p>虽然 Vite 的插件机制是基于 Rollup 来设计的，并且上一小节我们也已经对 Rollup 的插件机制进行了详细的解读，但实际上 Vite 的插件机制也包含了自己独有的一部分，与 Rollup 的各个插件 Hook 并非完全兼容，因此本节我们将重点关注 Vite 独有的部分以及和 Rollup 所区别的部分，而对于 Vite 和 Rollup 中相同的 Hook (如<code>resolveId</code>、<code>load</code>、<code>transform</code>)只是稍微提及，就不再展开赘述了。</p><p>让我们先从一个简单的例子入手吧！</p><h2 id="一个简单的插件示例" tabindex="-1"><a class="header-anchor" href="#一个简单的插件示例" aria-hidden="true">#</a> 一个简单的插件示例</h2><p>Vite 插件与 Rollup 插件结构类似，为一个<code>name</code>和各种插件 Hook 的对象:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  <span class="token comment">// 插件名称</span>
  name<span class="token operator">:</span> <span class="token string">&#39;vite-plugin-xxx&#39;</span><span class="token punctuation">,</span>
  <span class="token function">load</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 钩子逻辑</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>如果插件是一个 npm 包，在<code>package.json</code>中的包命名也推荐以<code>vite-plugin</code>开头</p></blockquote><p>一般情况下因为要考虑到外部传参，我们不会直接写一个对象，而是实现一个返回插件对象的<code>工厂函数</code>，如下代码所示:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// myPlugin.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">myVitePlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;vite-plugin-xxx&#39;</span><span class="token punctuation">,</span>
    <span class="token function">load</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在钩子逻辑中可以通过闭包访问外部的 options 传参</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用方式</span>
<span class="token comment">// vite.config.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> myVitePlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./myVitePlugin&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">myVitePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">/* 给插件传参 */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="插件-hook-介绍" tabindex="-1"><a class="header-anchor" href="#插件-hook-介绍" aria-hidden="true">#</a> 插件 Hook 介绍</h2><h3 id="_1-通用-hook" tabindex="-1"><a class="header-anchor" href="#_1-通用-hook" aria-hidden="true">#</a> 1. 通用 Hook</h3>`,13),d={href:"https://juejin.cn/book/7050063811973218341/section/7060398408430780431",target:"_blank",rel:"noopener noreferrer"},r=s("strong",null,"开发阶段",-1),k=a(`<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02910cd2c6894bcdb3a9e0fc9e59f4c2~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>其中 Vite 会调用一系列与 Rollup 兼容的钩子，这个钩子主要分为三个阶段:</p><ul><li><strong>服务器启动阶段</strong>: <code>options</code>和<code>buildStart</code>钩子会在服务启动时被调用。</li><li><strong>请求响应阶段</strong>: 当浏览器发起请求时，Vite 内部依次调用<code>resolveId</code>、<code>load</code>和<code>transform</code>钩子。</li><li><strong>服务器关闭阶段</strong>: Vite 会依次执行<code>buildEnd</code>和<code>closeBundle</code>钩子。</li></ul><p>除了以上钩子，其他 Rollup 插件钩子(如<code>moduleParsed</code>、<code>renderChunk</code>)均不会在 Vite <strong>开发阶段</strong>调用。而生产环境下，由于 Vite 直接使用 Rollup，Vite 插件中所有 Rollup 的插件钩子都会生效。</p><h3 id="_2-独有-hook" tabindex="-1"><a class="header-anchor" href="#_2-独有-hook" aria-hidden="true">#</a> 2. 独有 Hook</h3><p>接下来给大家介绍 Vite 中特有的一些 Hook，这些 Hook 只会在 Vite 内部调用，而放到 Rollup 中会被直接忽略。</p><h4 id="_2-1-给配置再加点料-config" tabindex="-1"><a class="header-anchor" href="#_2-1-给配置再加点料-config" aria-hidden="true">#</a> 2.1 给配置再加点料: config</h4><p>Vite 在读取完配置文件（即<code>vite.config.ts</code>）之后，会拿到用户导出的配置对象，然后执行 config 钩子。在这个钩子里面，你可以对配置文件导出的对象进行自定义的操作，如下代码所示:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 返回部分配置（推荐）</span>
<span class="token keyword">const</span> <span class="token function-variable function">editConfigPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&#39;vite-plugin-modify-config&#39;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">config</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      react<span class="token operator">:</span> <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;react&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>官方推荐的姿势是在 config 钩子中返回一个配置对象，这个配置对象会和 Vite 已有的配置进行深度的合并。不过你也可以通过钩子的入参拿到 config 对象进行自定义的修改，如下代码所示:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">mutateConfigPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&#39;mutate-config&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// command 为 \`serve\`(开发环境) 或者 \`build\`(生产环境)</span>
  <span class="token function">config</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span> command <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 生产环境中修改 root 参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">===</span> <span class="token string">&#39;build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span>root <span class="token operator">=</span> __dirname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在一些比较深层的对象配置中，这种直接修改配置的方式会显得比较麻烦，如 <code>optimizeDeps.esbuildOptions.plugins</code>，需要写很多的样板代码，类似下面这样:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 防止出现 undefined 的情况</span>
config<span class="token punctuation">.</span>optimizeDeps <span class="token operator">=</span> config<span class="token punctuation">.</span>optimizeDeps <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">.</span>esbuildOptions <span class="token operator">=</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">.</span>esbuildOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">.</span>esbuildOptions<span class="token punctuation">.</span>plugins <span class="token operator">=</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">.</span>esbuildOptions<span class="token punctuation">.</span>plugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此这种情况下，建议直接返回一个配置对象，这样会方便很多:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    optimizeDeps<span class="token operator">:</span> <span class="token punctuation">{</span>
      esbuildOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-记录最终配置-configresolved" tabindex="-1"><a class="header-anchor" href="#_2-2-记录最终配置-configresolved" aria-hidden="true">#</a> 2.2 记录最终配置: configResolved</h4><p>Vite 在解析完配置之后会调用<code>configResolved</code>钩子，这个钩子一般用来记录最终的配置信息，而不建议再修改配置，用法如下图所示:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">exmaplePlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> config

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;read-config&#39;</span><span class="token punctuation">,</span>

    <span class="token function">configResolved</span><span class="token punctuation">(</span>resolvedConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 记录最终配置</span>
      config <span class="token operator">=</span> resolvedConfig
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 在其他钩子中可以访问到配置</span>
    <span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-获取-dev-server-实例-configureserver" tabindex="-1"><a class="header-anchor" href="#_2-3-获取-dev-server-实例-configureserver" aria-hidden="true">#</a> 2.3 获取 Dev Server 实例: configureServer</h4><p>这个钩子仅在<strong>开发阶段</strong>会被调用，用于扩展 Vite 的 Dev Server，一般用于增加自定义 server 中间件，如下代码所示:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">myPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&#39;configure-server&#39;</span><span class="token punctuation">,</span>
  <span class="token function">configureServer</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 姿势 1: 在 Vite 内置中间件之前执行</span>
    server<span class="token punctuation">.</span>middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 自定义请求处理逻辑</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 姿势 2: 在 Vite 内置中间件之后执行 </span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      server<span class="token punctuation">.</span>middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 自定义请求处理逻辑</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-转换-html-内容-transformindexhtml" tabindex="-1"><a class="header-anchor" href="#_2-4-转换-html-内容-transformindexhtml" aria-hidden="true">#</a> 2.4 转换 HTML 内容: transformIndexHtml</h4><p>这个钩子用来灵活控制 HTML 的内容，你可以拿到原始的 html 内容后进行任意的转换:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">htmlPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;html-transform&#39;</span><span class="token punctuation">,</span>
    <span class="token function">transformIndexHtml</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
        <span class="token operator">/</span><span class="token operator">&lt;</span>title<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">title&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;title&gt;换了个标题&lt;/title&gt;</span><span class="token template-punctuation string">\`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 也可以返回如下的对象结构，一般用于添加某些标签</span>
<span class="token keyword">const</span> <span class="token function-variable function">htmlPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;html-transform&#39;</span><span class="token punctuation">,</span>
    <span class="token function">transformIndexHtml</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        html<span class="token punctuation">,</span>
        <span class="token comment">// 注入标签</span>
        tags<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token comment">// 放到 body 末尾，可取值还有\`head\`|\`head-prepend\`|\`body-prepend\`，顾名思义</span>
            injectTo<span class="token operator">:</span> <span class="token string">&#39;body&#39;</span><span class="token punctuation">,</span>
            <span class="token comment">// 标签属性定义</span>
            attrs<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;module&#39;</span><span class="token punctuation">,</span> src<span class="token operator">:</span> <span class="token string">&#39;./index.ts&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 标签名</span>
            tag<span class="token operator">:</span> <span class="token string">&#39;script&#39;</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-5-热更新处理-handlehotupdate" tabindex="-1"><a class="header-anchor" href="#_2-5-热更新处理-handlehotupdate" aria-hidden="true">#</a> 2.5 热更新处理: handleHotUpdate</h4><blockquote><p>关于热更新的概念和原理，我们会在下一节具体讲解。</p></blockquote><p>这个钩子会在 Vite 服务端处理热更新时被调用，你可以在这个钩子中拿到热更新相关的上下文信息，进行热更模块的过滤，或者进行自定义的热更处理。下面是一个简单的例子:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">handleHmrPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">handleHotUpdate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 需要热更的文件</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>file<span class="token punctuation">)</span>
      <span class="token comment">// 需要热更的模块，如一个 Vue 单文件会涉及多个模块</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>modules<span class="token punctuation">)</span>
      <span class="token comment">// 时间戳</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span>
      <span class="token comment">// Vite Dev Server 实例</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>server<span class="token punctuation">)</span>
      <span class="token comment">// 读取最新的文件内容</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 自行处理 HMR 事件</span>
      ctx<span class="token punctuation">.</span>server<span class="token punctuation">.</span>ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&#39;custom&#39;</span><span class="token punctuation">,</span>
        event<span class="token operator">:</span> <span class="token string">&#39;special-update&#39;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 前端代码中加入</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;special-update&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行自定义更新</span>
    <span class="token comment">// { a: 1 }</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上就是 Vite 独有的五个钩子，我们来重新梳理一下:</p><ul><li><code>config</code>: 用来进一步修改配置。</li><li><code>configResolved</code>: 用来记录最终的配置信息。</li><li><code>configureServer</code>: 用来获取 Vite Dev Server 实例，添加中间件。</li><li><code>transformIndexHtml</code>: 用来转换 HTML 的内容。</li><li><code>handleHotUpdate</code>: 用来进行热更新模块的过滤，或者进行自定义的热更新处理。</li></ul><h3 id="_3-插件-hook-执行顺序" tabindex="-1"><a class="header-anchor" href="#_3-插件-hook-执行顺序" aria-hidden="true">#</a> 3. 插件 Hook 执行顺序</h3><p>好，现在我们学习到了 Vite 的通用钩子和独有钩子，估计你现在脑子里面一点乱: 这么多的钩子，到底谁先执行、谁后执行呢？</p><p>下面，我们就来复盘一下上述的两类钩子，并且通过一个具体的代码示例来汇总一下所有的钩子。我们可以在 Vite 的脚手架工程中新建 <code>test-hooks-plugin.ts</code>:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// test-hooks-plugin.ts</span>
<span class="token comment">// 注: 请求响应阶段的钩子</span>
<span class="token comment">// 如 resolveId, load, transform, transformIndexHtml在下文介绍</span>
<span class="token comment">// 以下为服务启动和关闭的钩子</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">testHookPlugin</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;test-hooks-plugin&#39;</span><span class="token punctuation">,</span> 
    <span class="token comment">// Vite 独有钩子</span>
    <span class="token function">config</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;config&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// Vite 独有钩子</span>
    <span class="token function">configResolved</span><span class="token punctuation">(</span>resolvedCofnig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;configResolved&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 通用钩子</span>
    <span class="token function">options</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;options&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> opts<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// Vite 独有钩子</span>
    <span class="token function">configureServer</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;configureServer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 手动退出进程</span>
        process<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> <span class="token string">&#39;SIGTERM&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 通用钩子</span>
    <span class="token function">buildStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;buildStart&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 通用钩子</span>
    <span class="token function">buildEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;buildEnd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 通用钩子</span>
    <span class="token function">closeBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;closeBundle&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将插件加入到 Vite 配置文件中，然后启动，你可以观察到各个 Hook 的执行顺序:</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/339255d0cdba48a2832f720a895892c9~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>由此我们可以梳理出 Vite 插件的执行顺序:</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83c255efbdec4c66971a30ff270c70a9~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><ul><li>服务启动阶段: <code>config</code>、<code>configResolved</code>、<code>options</code>、<code>configureServer</code>、<code>buildStart</code></li><li>请求响应阶段: 如果是 <code>html</code> 文件，仅执行<code>transformIndexHtml</code>钩子；对于非 HTML 文件，则依次执行<code>resolveId</code>、<code>load</code>和<code>transform</code>钩子。相信大家学过 Rollup 的插件机制，已经对这三个钩子比较熟悉了。</li><li>热更新阶段: 执行<code>handleHotUpdate</code>钩子。</li><li>服务关闭阶段: 依次执行<code>buildEnd</code>和<code>closeBundle</code>钩子。</li></ul><h2 id="插件应用位置" tabindex="-1"><a class="header-anchor" href="#插件应用位置" aria-hidden="true">#</a> 插件应用位置</h2><p>梳理完 Vite 的各个钩子函数之后，接下来让我们来了解一下 Vite 插件的<strong>应用情景</strong>和<strong>应用顺序</strong>。</p><p>默认情况下 Vite 插件同时被用于开发环境和生产环境，你可以通过<code>apply</code>属性来决定应用场景:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  <span class="token comment">// &#39;serve&#39; 表示仅用于开发环境，&#39;build&#39;表示仅用于生产环境</span>
  apply<span class="token operator">:</span> <span class="token string">&#39;serve&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>apply</code>参数还可以配置成一个函数，进行更灵活的控制:</p><div class="language-ts! line-numbers-mode" data-ext="ts!"><pre class="language-ts!"><code>apply(config, { command }) {
  // 只用于非 SSR 情况下的生产环境构建
  return command === &#39;build&#39; &amp;&amp; !config.build.ssr
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同时，你也可以通过<code>enforce</code>属性来指定插件的执行顺序:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  <span class="token comment">// 默认为\`normal\`，可取值还有\`pre\`和\`post\`</span>
  enforce<span class="token operator">:</span> <span class="token string">&#39;pre&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Vite 中插件的执行顺序如下图所示:</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d06b07cd29434ec9af7f9ea3fd39cba0~tplv-k3u1fbpfcp-watermark.image?" alt="plugin.png"></p><p>Vite 会依次执行如下的插件:</p><blockquote></blockquote><ul><li>Alias (路径别名)相关的插件。</li><li>⭐️ 带有 <code>enforce: &#39;pre&#39;</code> 的用户插件。</li><li>Vite 核心插件。</li><li>⭐️ 没有 enforce 值的用户插件，也叫<code>普通插件</code>。</li><li>Vite 生产环境构建用的插件。</li><li>⭐️ 带有 <code>enforce: &#39;post&#39;</code> 的用户插件。</li><li>Vite 后置构建插件(如压缩插件)。</li></ul><h2 id="插件开发实战" tabindex="-1"><a class="header-anchor" href="#插件开发实战" aria-hidden="true">#</a> 插件开发实战</h2><p>接下来我们进入插件开发的实战环节中，在这个部分我们将一起编写两个 Vite 插件，分别是<code>虚拟模块加载插件</code>和<code>Svgr 插件</code>，你将学会从插件开发的常见套路和各种开发技巧。话不多说，让我们现在开始实战吧。</p><h3 id="实战案例-1-虚拟模块加载" tabindex="-1"><a class="header-anchor" href="#实战案例-1-虚拟模块加载" aria-hidden="true">#</a> 实战案例 1: 虚拟模块加载</h3><p>首先我们来实现一个虚拟模块的加载插件，可能你会有疑问: 什么是虚拟模块呢？</p><p>作为构建工具，一般需要处理两种形式的模块，一种存在于真实的磁盘文件系统中，另一种并不在磁盘而在内存当中，也就是<code>虚拟模块</code>。通过虚拟模块，我们既可以把自己手写的一些代码字符串作为单独的模块内容，又可以将内存中某些经过计算得出的<strong>变量</strong>作为模块内容进行加载，非常灵活和方便。接下来让我们通过一些具体的例子来实操一下，首先通过脚手架命令初始化一个<code>react + ts</code>项目:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>npm init vite
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后通过<code>pnpm i</code>安装依赖，接着新建<code>plugins</code>目录，开始插件的开发:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// plugins/virtual-module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vite&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// 虚拟模块名称</span>
<span class="token keyword">const</span> virtualFibModuleId <span class="token operator">=</span> <span class="token string">&#39;virtual:fib&#39;</span><span class="token punctuation">;</span>
<span class="token comment">// Vite 中约定对于虚拟模块，解析后的路径需要加上\`\\0\`前缀</span>
<span class="token keyword">const</span> resolvedFibVirtualModuleId <span class="token operator">=</span> <span class="token string">&#39;\\0&#39;</span> <span class="token operator">+</span> virtualFibModuleId<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">virtualFibModulePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin <span class="token punctuation">{</span>
  <span class="token keyword">let</span> config<span class="token operator">:</span> ResolvedConfig <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;vite-plugin-virtual-module&#39;</span><span class="token punctuation">,</span>
    <span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> virtualFibModuleId<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> resolvedFibVirtualModuleId<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">load</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 加载虚拟模块</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> resolvedFibVirtualModuleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&#39;export default function fib(n) { return n &lt;= 1 ? n : fib(n - 1) + fib(n - 2); }&#39;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着我们在项目中来使用这个插件:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// vite.config.ts</span>
<span class="token keyword">import</span> virtual <span class="token keyword">from</span> <span class="token string">&#39;./plugins/virtual-module.ts&#39;</span>

<span class="token comment">// 配置插件</span>
<span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">virtual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后在<code>main.tsx</code>中加入如下的代码:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> fib <span class="token keyword">from</span> <span class="token string">&#39;virtual:fib&#39;</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我们使用了 <code>virtual:fib</code> 这个虚拟模块，虽然这个模块不存在真实的文件系统中，但你打开浏览器后可以发现这个模块导出的函数是可以正常执行的:</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/216e84976e3c408cb845b64bf329943f~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>接着我们来尝试一下如何通过虚拟模块来读取内存中的变量，在<code>virtual-module.ts</code>中增加如下代码:</p><div class="language-diff line-numbers-mode" data-ext="diff"><pre class="language-diff"><code>import { Plugin, ResolvedConfig } from &#39;vite&#39;;

const virtualFibModuleId = &#39;virtual:fib&#39;;
const resolvedFibVirtualModuleId = &#39;\\0&#39; + virtualFibModuleId;

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const virtualEnvModuleId = &#39;virtual:env&#39;;
</span><span class="token prefix inserted">+</span><span class="token line"> const resolvedEnvVirtualModuleId = &#39;\\0&#39; + virtualEnvModuleId;
</span></span>
export default function virtualFibModulePlugin(): Plugin {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   let config: ResolvedConfig | null = null;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return {
</span><span class="token prefix unchanged"> </span><span class="token line">   name: &#39;vite-plugin-virtual-fib-module&#39;,
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     configResolved(c: ResolvedConfig) {
</span><span class="token prefix inserted">+</span><span class="token line">       config = c;
</span><span class="token prefix inserted">+</span><span class="token line">     },
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   resolveId(id) {
</span><span class="token prefix unchanged"> </span><span class="token line">     if (id === virtualFibModuleId) { 
</span><span class="token prefix unchanged"> </span><span class="token line">       return resolvedFibVirtualModuleId;
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       if (id === virtualEnvModuleId) { 
</span><span class="token prefix inserted">+</span><span class="token line">        return resolvedEnvVirtualModuleId;
</span><span class="token prefix inserted">+</span><span class="token line">      }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   },
</span><span class="token prefix unchanged"> </span><span class="token line">   load(id) {
</span><span class="token prefix unchanged"> </span><span class="token line">     if (id === resolvedFibVirtualModuleId) {
</span><span class="token prefix unchanged"> </span><span class="token line">       return &#39;export default function fib(n) { return n &lt;= 1 ? n : fib(n - 1) + fib(n - 2); }&#39;;
</span><span class="token prefix unchanged"> </span><span class="token line">     }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      if (id === resolvedEnvVirtualModuleId) {
</span><span class="token prefix inserted">+</span><span class="token line">        return \`export default \${JSON.stringify(config!.env)}\`;
</span><span class="token prefix inserted">+</span><span class="token line">      }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在新增的这些代码中，我们注册了一个新的虚拟模块<code>virtual:env</code>，紧接着我们去项目去使用:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// main.tsx</span>
<span class="token keyword">import</span> env <span class="token keyword">from</span> <span class="token string">&#39;virtual:env&#39;</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>virtual:env</code>一般情况下会有类型问题，我们需要增加一个类型声明文件来声明这个模块:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// types/shim.d.ts</span>
<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">&#39;virtual:*&#39;</span> <span class="token punctuation">{</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样就解决了类型报错的问题。接着你可以去浏览器观察一下输出的情况:</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59c04f44a5334138ab722400c03c071c~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>Vite 环境变量能正确地在浏览器中打印出来，说明在内存中计算出来的<code>virtual:env</code>模块的确被成功地加载了。从中你可以看到，虚拟模块的内容完全能够被动态计算出来，因此它的灵活性和可定制程度非常高，实用性也很强，在 Vite 内部的插件被深度地使用，社区当中也有不少知名的插件(如 <code>vite-plugin-windicss</code>、<code>vite-plugin-svg-icons</code>等)也使用了虚拟模块的技术。</p><h3 id="实战案例-2-svg-组件形式加载" tabindex="-1"><a class="header-anchor" href="#实战案例-2-svg-组件形式加载" aria-hidden="true">#</a> 实战案例 2: Svg 组件形式加载</h3><p>在一般的项目开发过程中，我们有时候希望能将 svg 当做一个组件来引入，这样我们可以很方便地修改 svg 的各种属性，相比于<code>img</code>标签的引入方式也更加优雅。但 Vite 本身并不支持将 svg 转换为组件的代码，需要我们通过插件来实现。</p><p>接下来我们就来写一个 Vite 插件，实现在 React 项目能够通过组件方式来使用 svg 资源。首先安装一下需要的依赖:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">pnpm</span> i resolve @svgr/core <span class="token parameter variable">-D</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>接着在<code>plugins</code>目录新建 <code>svgr.ts</code>:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vite&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&#39;fs&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> resolve <span class="token keyword">from</span> <span class="token string">&#39;resolve&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">SvgrOptions</span> <span class="token punctuation">{</span>
  <span class="token comment">// svg 资源模块默认导出，url 或者组件</span>
  defaultExport<span class="token operator">:</span> <span class="token string">&#39;url&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;component&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">viteSvgrPlugin</span><span class="token punctuation">(</span>options<span class="token operator">:</span> SvgrOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> defaultExport<span class="token operator">=</span><span class="token string">&#39;url&#39;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;vite-plugin-svgr&#39;</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>code <span class="token punctuation">,</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 转换逻辑: svg -&gt; React 组件</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>让我们先来梳理一下开发需求，用户通过传入<code>defaultExport</code>可以控制 svg 资源的默认导出:</p><ul><li>当 <code>defaultExport</code>为 <code>component</code>，默认当做组件来使用，即:</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> Logo <span class="token keyword">from</span> <span class="token string">&#39;./Logo.svg&#39;</span>

<span class="token comment">// 在组件中直接使用</span>
<span class="token operator">&lt;</span>Logo <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>当<code>defaultExports</code>为<code>url</code>，默认当做 url 使用，如果需要用作组件，可以通过<code>具名导入</code>的方式来支持:</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> logoUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span> ReactComponent <span class="token keyword">as</span> Logo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./logo.svg&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// url 使用</span>
<span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token punctuation">{</span>logoUrl<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token comment">// 组件方式使用</span>
<span class="token operator">&lt;</span>Logo <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>明确了需求之后，接下来让我们来整理一下插件开发的整体思路，主要逻辑在 <code>transform</code>钩子中完成，流程如下:</p><ul><li><ol><li>根据 id 入参过滤出 svg 资源；</li></ol></li><li><ol start="2"><li>读取 svg 文件内容；</li></ol></li><li><ol start="3"><li>利用 <code>@svgr/core</code> 将 svg 转换为 React 组件代码;</li></ol></li><li><ol start="4"><li>处理默认导出为 url 的情况；</li></ol></li><li><ol start="5"><li>将组件的 jsx 代码转译为浏览器可运行的代码。</li></ol></li></ul><p>下面是插件的完整的代码，你可以参考学习:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vite&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fs <span class="token keyword">from</span> <span class="token string">&#39;fs&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> resolve <span class="token keyword">from</span> <span class="token string">&#39;resolve&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">SvgrOptions</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">defaultExport</span><span class="token operator">:</span> <span class="token string">&#39;url&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;component&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">viteSvgrPlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> SvgrOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> defaultExport<span class="token operator">=</span><span class="token string">&#39;component&#39;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;vite-plugin-svgr&#39;</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. 根据 id 入参过滤出 svg 资源；</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>id<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.svg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> svgrTransform <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@svgr/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transform<span class="token punctuation">;</span>
      <span class="token comment">// 解析 esbuild 的路径，后续转译 jsx 会用到，我们这里直接拿 vite 中的 esbuild 即可</span>
      <span class="token keyword">const</span> esbuildPackagePath <span class="token operator">=</span> resolve<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&#39;esbuild&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">basedir</span><span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;vite&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> esbuild <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>esbuildPackagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2. 读取 svg 文件内容；</span>
      <span class="token keyword">const</span> svg <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3. 利用 \`@svgr/core\` 将 svg 转换为 React 组件代码</span>
      <span class="token keyword">const</span> svgrResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">svgrTransform</span><span class="token punctuation">(</span>
        svg<span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">componentName</span><span class="token operator">:</span> <span class="token string">&#39;ReactComponent&#39;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4. 处理默认导出为 url 的情况</span>
      <span class="token keyword">let</span> componentCode <span class="token operator">=</span> svgrResult<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultExport <span class="token operator">===</span> <span class="token string">&#39;url&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加上 Vite 默认的 \`export default 资源路径\`</span>
        componentCode <span class="token operator">+=</span> code<span class="token punctuation">;</span>
        componentCode <span class="token operator">=</span> componentCode<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&#39;export default ReactComponent&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;export { ReactComponent }&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 5. 利用 esbuild，将组件中的 jsx 代码转译为浏览器可运行的代码;</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> esbuild<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>componentCode<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&#39;jsx&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
        <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token comment">// TODO</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来让我们在项目中使用这个插件:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// vite.config.ts</span>
<span class="token keyword">import</span> svgr <span class="token keyword">from</span> <span class="token string">&#39;./plugins/svgr&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// 返回的配置</span>
<span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 省略其它插件</span>
    <span class="token function">svgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着我们在项目中用组件的方式引入 svg:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// App.tsx</span>
<span class="token keyword">import</span> Logo <span class="token keyword">from</span> <span class="token string">&#39;./logo.svg&#39;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Logo <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打开浏览器，可以看到组件已经正常显示:</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad0d1812f0ac49759d2f284f49502ea9~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><h3 id="调试技巧" tabindex="-1"><a class="header-anchor" href="#调试技巧" aria-hidden="true">#</a> 调试技巧</h3><p>另外，在开发调试插件的过程，我推荐大家在本地装上<code>vite-plugin-inspect</code>插件，并在 Vite 中使用它:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// vite.config.ts</span>
<span class="token keyword">import</span> inspect <span class="token keyword">from</span> <span class="token string">&#39;vite-plugin-inspect&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// 返回的配置</span>
<span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 省略其它插件</span>
    <span class="token function">inspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样当你再次启动项目时，会发现多出一个调试地址:</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/606340bc8b9b4f81be0b0ac22516f838~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>你可以通过这个地址来查看项目中各个模块的编译结果：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e972fc35eac4c168872317709707e5a~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>点击特定的文件后，你可以看到这个模块经过各个插件处理后的中间结果，如下图所示:</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d40c06d94c96412cbf9fc2dccf35d5f1~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>通过这个面板，我们可以很清楚地看到相应模块经过插件处理后变成了什么样子，让插件的调试更加方便。</p><h2 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h2><p>好，本节的内容到这里就接近尾声了。本节你需要重点掌握 Vite <strong>插件钩子的含义</strong>、<strong>作用顺序</strong>以及<strong>插件的实战开发</strong>。</p><p>首先我通过一个最简单的示例让你对 Vite 插件的结构有了初步的印象，然后对 Vite 中的各种钩子函数进行了介绍，主要包括<code>通用钩子</code>和<code>独有钩子</code>，通用钩子与 Rollup 兼容，而独有钩子在 Rollup 中会被忽略。而由于上一节已经详细介绍了 Rollup 的插件机制，对于通用钩子我们没有继续展开，而是详细介绍了 5 个独有钩子，分别是: <code>config</code>、<code>configResolved</code>、<code>configureServer</code>、<code>transformIndexHtml</code>和<code>handleHotUpdate</code>。不仅如此，我还给你从宏观角度分析了 Vite 插件的作用场景和作用顺序，你可以分别通过<code>apply</code>和<code>enforce</code>两个参数来进行手动的控制。</p><p>接下来我们正式进入插件开发实战的环节，实现了<code>虚拟模块加载插件</code>和<code>Svg 组件加载插件</code>，相信你已经对虚拟模块的概念和使用有了直观的了解，也能通过后者的开发过程了解到如何在 Vite 中集成其它的前端编译工具。总体来说，Vite 插件的设计秉承了 Rollup 的插件设计理念，通过一个个语义化的 Hook 来组织，十分简洁和灵活，上手难度并不大，但真正难的地方在于如何利用 Vite 插件去解决实际开发过程的问题，由于篇幅所限，本文的示例并不能覆盖所有的开发场景，你也不必着急，我们会在后面的几个小节中接触到更加高级的开发场景，你也将接触过越来越多的插件，当然，你的插件开发技能也能越来越纯熟。大家继续加油💪🏻！</p>`,110);function v(m,b){const e=p("ExternalLinkIcon");return o(),i("div",null,[u,s("p",null,[n("在"),s("a",d,[n("双引擎架构"),c(e)]),n("这一节中介绍过，Vite "),r,n("会模拟 Rollup 的行为:")]),k])}const f=t(l,[["render",v],["__file","di12zhang—chajiankaifayushizhan：ruhekaifayigewanzhengdeVitechajian.html.vue"]]);export{f as default};
